/*!
  backbone.fetch-cache v0.1.0 (2012-12-14)
  by Andy Appleton - https://github.com/mrappleton/backbone-fetch-cache.git
 */
(function(e){var t=Backbone.Model.prototype.fetch,n=typeof window.localStorage!="undefined";Backbone.Model.attributeCache={},typeof Backbone.Model.localStorageCache=="undefined"&&(Backbone.Model.localStorageCache=!0),Backbone.Model.setCache=function(e,t){t=t||{};var n=_.isFunction(e.url)?e.url():e.url,r=!1;if(!n)return;t.expires!==!1&&(r=(new Date).getTime()+(t.expires||300)*1e3),this.attributeCache[n]={expires:r,value:e.toJSON()},this.setLocalStorage()},Backbone.Model.setLocalStorage=function(){if(!n||!Backbone.Model.localStorageCache)return;localStorage.setItem("modelCache",JSON.stringify(Backbone.Model.attributeCache))},Backbone.Model.getLocalStorage=function(){if(!n||!Backbone.Model.localStorageCache)return;Backbone.Model.attributeCache=JSON.parse(localStorage.getItem("modelCache"))||{}},Backbone.Model.prototype.fetch=function(e){e=e||{};var n=_.isFunction(this.url)?this.url():this.url,r=Backbone.Model.attributeCache[n],i=!1,s=!1;return r&&(i=r.expires,i=i&&r.expires<(new Date).getTime(),s=r.value),!i&&e.cache&&s?(this.set(s,e),_.isFunction(e.success)&&e.success(this),(new $.Deferred).resolve(this)):t.apply(this,arguments).done(_.bind(Backbone.Model.setCache,Backbone.Model,this,e))},Backbone.Model.getLocalStorage()})(),function(){var e=Backbone.Collection.prototype.fetch,t=typeof window.localStorage!="undefined";Backbone.Collection.attributeCache={},typeof Backbone.Collection.localStorageCache=="undefined"&&(Backbone.Collection.localStorageCache=!0),Backbone.Collection.setCache=function(e,t){t=t||{};var n=_.isFunction(e.url)?e.url():e.url,r=!1;if(!n)return;t.expires!==!1&&(r=(new Date).getTime()+(t.expires||300)*1e3),this.attributeCache[n]={expires:r,value:e.toJSON()},this.setLocalStorage()},Backbone.Collection.setLocalStorage=function(){if(!t||!Backbone.Collection.localStorageCache)return;localStorage.setItem("collectionCache",JSON.stringify(Backbone.Collection.attributeCache))},Backbone.Collection.getLocalStorage=function(){if(!t||!Backbone.Collection.localStorageCache)return;Backbone.Collection.attributeCache=JSON.parse(localStorage.getItem("collectionCache"))||{}},Backbone.Collection.prototype.fetch=function(t){t=t||{};var n=_.isFunction(this.url)?this.url():this.url,r=Backbone.Collection.attributeCache[n],i=!1,s=!1;return r&&(i=r.expires,i=i&&r.expires<(new Date).getTime(),s=r.value),!i&&t.cache&&s?(this[t.add?"add":"reset"](this.parse(s),t),_.isFunction(t.success)&&t.success(this),(new $.Deferred).resolve(this)):e.apply(this,arguments).done(_.bind(Backbone.Collection.setCache,Backbone.Collection,this,t))},Backbone.Collection.getLocalStorage()}();