/*  backbone.fetch-cache v0.1.7 (2013-06-18)
  by Andy Appleton - https://github.com/mrappleton/backbone-fetch-cache.git
 */
!function(a,b){"function"==typeof define&&define.amd?define(["underscore","backbone"],function(_,Backbone){return a.Backbone=b(_,Backbone)}):a.Backbone=b(a._,a.Backbone)}(this,function(_,Backbone){function a(a,b,c){b=b||{};var d=_.isFunction(a.url)?a.url():a.url,e=!1;d&&b.cache!==!1&&(b.cache||b.prefill)&&(b.expires!==!1&&(e=(new Date).getTime()+1e3*(b.expires||300)),Backbone.fetchCache._cache[d]={expires:e,value:c},Backbone.fetchCache.setLocalStorage())}function b(a){delete Backbone.fetchCache._cache[a]}function c(){if(f&&Backbone.fetchCache.localStorage)try{localStorage.setItem("backboneCache",JSON.stringify(Backbone.fetchCache._cache))}catch(a){var b=a.code||a.number||a.message;if(22!==b)throw a;this._deleteCacheWithPriority()}}function d(){if(f&&Backbone.fetchCache.localStorage){var a=localStorage.getItem("backboneCache")||"{}";Backbone.fetchCache._cache=JSON.parse(a)}}var e={modelFetch:Backbone.Model.prototype.fetch,modelSync:Backbone.Model.prototype.sync,collectionFetch:Backbone.Collection.prototype.fetch},f="undefined"!=typeof window.localStorage;return Backbone.fetchCache=Backbone.fetchCache||{},Backbone.fetchCache._cache=Backbone.fetchCache._cache||{},Backbone.fetchCache.priorityFn=function(a,b){return a&&a.expires&&b&&b.expires?a.expires-b.expires:a},Backbone.fetchCache._prioritize=function(){var a=_.values(this._cache).sort(this.priorityFn),b=_.indexOf(_.values(this._cache),a[0]);return _.keys(this._cache)[b]},Backbone.fetchCache._deleteCacheWithPriority=function(){Backbone.fetchCache._cache[this._prioritize()]=null,delete Backbone.fetchCache._cache[this._prioritize()],Backbone.fetchCache.setLocalStorage()},"undefined"==typeof Backbone.fetchCache.localStorage&&(Backbone.fetchCache.localStorage=!0),Backbone.Model.prototype.fetch=function(a){a=a||{};var b=_.isFunction(this.url)?this.url():this.url,c=Backbone.fetchCache._cache[b],d=!1,f=!1,g=new $.Deferred;if(c&&(d=c.expires,d=d&&c.expires<(new Date).getTime(),f=c.value),!d&&(a.cache||a.prefill)&&f){if(this.set(this.parse(f),a),_.isFunction(a.prefillSuccess)&&a.prefillSuccess(this,f,a),this.trigger("sync",this,f,a),!a.prefill)return _.isFunction(a.success)&&a.success(this),g.resolve(this);g.notify(this)}return e.modelFetch.apply(this,arguments).done(_.bind(g.resolve,this,this)).done(_.bind(Backbone.fetchCache.setCache,null,this,a)).fail(_.bind(g.reject,this,this)),g},Backbone.Model.prototype.sync=function(a,c){if("read"===a)return e.modelSync.apply(this,arguments);var d,f,g=c.collection,h=[];for(h.push(_.isFunction(c.url)?c.url():c.url),g&&h.push(_.isFunction(g.url)?g.url():g.url),d=0,f=h.length;f>d;d++)b(h[d]);return e.modelSync.apply(this,arguments)},Backbone.Collection.prototype.fetch=function(a){a=a||{};var b=_.isFunction(this.url)?this.url():this.url,c=Backbone.fetchCache._cache[b],d=!1,f=!1,g=new $.Deferred;if(c&&(d=c.expires,d=d&&c.expires<(new Date).getTime(),f=c.value),!d&&(a.cache||a.prefill)&&f){if(this[a.reset?"reset":"set"](this.parse(f),a),_.isFunction(a.prefillSuccess)&&a.prefillSuccess(this),!a.prefill)return _.isFunction(a.success)&&a.success(this),g.resolve(this);g.notify(this)}return e.collectionFetch.apply(this,arguments).done(_.bind(g.resolve,this,this)).done(_.bind(Backbone.fetchCache.setCache,null,this,a)).fail(_.bind(g.reject,this,this)),g},d(),Backbone.fetchCache._superMethods=e,Backbone.fetchCache.setCache=a,Backbone.fetchCache.clearItem=b,Backbone.fetchCache.setLocalStorage=c,Backbone.fetchCache.getLocalStorage=d,Backbone});