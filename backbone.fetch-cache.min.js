/*  backbone.fetch-cache v1.0.2 (2013-08-22)
  by Andy Appleton - https://github.com/mrappleton/backbone-fetch-cache.git
 */
!function(a,b){"function"==typeof define&&define.amd?define(["underscore","backbone"],function(_,Backbone){return a.Backbone=b(_,Backbone)}):a.Backbone=b(a._,a.Backbone,a.jQuery)}(this,function(_,Backbone,a){function b(b,c){var d;return(d=c&&c.url?c.url:_.isFunction(b.url)?b.url():b.url)?c&&c.data?d+"?"+a.param(c.data):d:void 0}function c(a,b,c){b=b||{};var d=Backbone.fetchCache.getCacheKey(a,b),e=!1;d&&b.cache!==!1&&(b.cache||b.prefill)&&(b.expires!==!1&&(e=(new Date).getTime()+1e3*(b.expires||300)),Backbone.fetchCache._cache[d]={expires:e,value:c},Backbone.fetchCache.setLocalStorage())}function d(a){delete Backbone.fetchCache._cache[a],Backbone.fetchCache.setLocalStorage()}function e(){if(i&&Backbone.fetchCache.localStorage)try{localStorage.setItem("backboneCache",JSON.stringify(Backbone.fetchCache._cache))}catch(a){var b=a.code||a.number||a.message;if(22!==b)throw a;this._deleteCacheWithPriority()}}function f(){if(i&&Backbone.fetchCache.localStorage){var a=localStorage.getItem("backboneCache")||"{}";Backbone.fetchCache._cache=JSON.parse(a)}}function g(a){return window.setTimeout(a,0)}var h={modelFetch:Backbone.Model.prototype.fetch,modelSync:Backbone.Model.prototype.sync,collectionFetch:Backbone.Collection.prototype.fetch},i=function(){var a="undefined"!=typeof window.localStorage;if(a)try{localStorage.setItem("test_support","test_support"),localStorage.removeItem("test_support")}catch(b){a=!1}return a}();return Backbone.fetchCache=Backbone.fetchCache||{},Backbone.fetchCache._cache=Backbone.fetchCache._cache||{},Backbone.fetchCache.priorityFn=function(a,b){return a&&a.expires&&b&&b.expires?a.expires-b.expires:a},Backbone.fetchCache._prioritize=function(){var a=_.values(this._cache).sort(this.priorityFn),b=_.indexOf(_.values(this._cache),a[0]);return _.keys(this._cache)[b]},Backbone.fetchCache._deleteCacheWithPriority=function(){Backbone.fetchCache._cache[this._prioritize()]=null,delete Backbone.fetchCache._cache[this._prioritize()],Backbone.fetchCache.setLocalStorage()},"undefined"==typeof Backbone.fetchCache.localStorage&&(Backbone.fetchCache.localStorage=!0),Backbone.Model.prototype.fetch=function(b){b=b||{};var c=Backbone.fetchCache.getCacheKey(this,b),d=Backbone.fetchCache._cache[c],e=!1,f=!1,i=new a.Deferred,j=this;return d&&(e=d.expires,e=e&&d.expires<(new Date).getTime(),f=d.value),e||!b.cache&&!b.prefill||!f||(g(function(){j.set(j.parse(f),b),_.isFunction(b.prefillSuccess)&&b.prefillSuccess(j,f,b),j.trigger("cachesync",j,f,b),j.trigger("sync",j,f,b),b.prefill?i.notify(j):(_.isFunction(b.success)&&b.success(j,f,b),i.resolve(j))}),b.prefill)?(h.modelFetch.apply(this,arguments).done(_.bind(i.resolve,this,this)).done(_.bind(Backbone.fetchCache.setCache,null,this,b)).fail(_.bind(i.reject,this,this)),i.promise()):i.promise()},Backbone.Model.prototype.sync=function(a,b){if("read"===a)return h.modelSync.apply(this,arguments);var c,e,f=b.collection,g=[];for(g.push(Backbone.fetchCache.getCacheKey(b)),f&&g.push(Backbone.fetchCache.getCacheKey(f)),c=0,e=g.length;e>c;c++)d(g[c]);return h.modelSync.apply(this,arguments)},Backbone.Collection.prototype.fetch=function(b){b=b||{};var c=Backbone.fetchCache.getCacheKey(this,b),d=Backbone.fetchCache._cache[c],e=!1,f=!1,i=new a.Deferred,j=this;return d&&(e=d.expires,e=e&&d.expires<(new Date).getTime(),f=d.value),e||!b.cache&&!b.prefill||!f||(g(function(){j[b.reset?"reset":"set"](j.parse(f),b),_.isFunction(b.prefillSuccess)&&b.prefillSuccess(j),j.trigger("cachesync",j,f,b),j.trigger("sync",j,f,b),b.prefill?i.notify(j):(_.isFunction(b.success)&&b.success(j,f,b),i.resolve(j))}),b.prefill)?(h.collectionFetch.apply(this,arguments).done(_.bind(i.resolve,this,this)).done(_.bind(Backbone.fetchCache.setCache,null,this,b)).fail(_.bind(i.reject,this,this)),i.promise()):i.promise()},f(),Backbone.fetchCache._superMethods=h,Backbone.fetchCache.setCache=c,Backbone.fetchCache.getCacheKey=b,Backbone.fetchCache.clearItem=d,Backbone.fetchCache.setLocalStorage=e,Backbone.fetchCache.getLocalStorage=f,Backbone});